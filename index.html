<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.devmgr.cn","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="GeXiangDong">
<meta property="og:url" content="https://blog.devmgr.cn/index.html">
<meta property="og:site_name" content="GeXiangDong">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="GeXiangDong">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://blog.devmgr.cn/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>GeXiangDong</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">GeXiangDong</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">精通Java、SQL、Spring的拼写，擅长Linux、Windows的开关机</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.devmgr.cn/2023/02/19/postgresql-select-max-x-vs-select-x-order-by-x-desc-limit-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="GeXiangDong">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeXiangDong">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/19/postgresql-select-max-x-vs-select-x-order-by-x-desc-limit-1/" class="post-title-link" itemprop="url">PostgreSQL: select max(x) vs select x ... order by x desc limit 1</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-02-19 09:13:08 / 修改时间：10:11:49" itemprop="dateCreated datePublished" datetime="2023-02-19T09:13:08+08:00">2023-02-19</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在通常状况下（不利用索引），用max来查询一个字段的最大值是最佳选择，使用oder by这种方式相比max肯定是一个糟糕至极的选择。</p>
<p>但是在恰当的利用索引的情况下，PostgreSQL order by  limit 1 这种方式给出了不同的结果。</p>
<h2 id="比较-I（where中包含一个字段）"><a href="#比较-I（where中包含一个字段）" class="headerlink" title="比较 I（where中包含一个字段）"></a>比较 I（where中包含一个字段）</h2><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><p>table</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> user_login_record(</span><br><span class="line">  user_id         <span class="built_in">char</span>(<span class="number">36</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">  login_date    <span class="built_in">timestamp</span>  <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>上面这个表（请忽略它并不符合实际的业务或者编码设计规范），有2个字段，我们根据user_id 来查询最后一个 login_date</p>
<p>我们忽略掉无索引的状况（正如前文所说max在无索引时性能最佳），直接建立索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> user_login_date <span class="keyword">on</span> user_login_record (user_id, login_date <span class="keyword">desc</span>);</span><br></pre></td></tr></table></figure>


<h3 id="比较结果"><a href="#比较结果" class="headerlink" title="比较结果"></a>比较结果</h3><p>我们来比较2个SQL的性能</p>
<h4 id="max"><a href="#max" class="headerlink" title="max"></a>max</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> (<span class="keyword">analyze</span>, buffers, costs) </span><br><span class="line"><span class="keyword">select</span> <span class="keyword">max</span>(login_date) </span><br><span class="line"><span class="keyword">from</span> user_login_record </span><br><span class="line"><span class="keyword">where</span> user_id=<span class="string">&#x27;952bd155-06b3-4792-82ec-4b86d06c86a7&#x27;</span></span><br></pre></td></tr></table></figure>


<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">                                                                        QUERY PLAN                                                                        </span><br><span class="line">----------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> Result  (cost&#x3D;0.45..0.46 rows&#x3D;1 width&#x3D;8) (actual time&#x3D;0.074..0.075 rows&#x3D;1 loops&#x3D;1)</span><br><span class="line">   Buffers: shared hit&#x3D;4</span><br><span class="line">   InitPlan 1 (returns $0)</span><br><span class="line">     -&gt;  Limit  (cost&#x3D;0.41..0.45 rows&#x3D;1 width&#x3D;8) (actual time&#x3D;0.071..0.071 rows&#x3D;1 loops&#x3D;1)</span><br><span class="line">           Buffers: shared hit&#x3D;4</span><br><span class="line">           -&gt;  Index Only Scan using user_login_date on user_login_record  (cost&#x3D;0.41..32.76 rows&#x3D;1077 width&#x3D;8) (actual time&#x3D;0.070..0.070 rows&#x3D;1 loops&#x3D;1)</span><br><span class="line">                 Index Cond: ((user_id &#x3D; &#39;952bd155-06b3-4792-82ec-4b86d06c86a7&#39;::bpchar) AND (login_date IS NOT NULL))</span><br><span class="line">                 Heap Fetches: 0</span><br><span class="line">                 Buffers: shared hit&#x3D;4</span><br><span class="line"> Planning Time: 0.124 ms</span><br><span class="line"> Execution Time: 0.097 ms</span><br><span class="line">(11 rows)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="order-by-…-desc-limit-1"><a href="#order-by-…-desc-limit-1" class="headerlink" title="order by … desc limit 1"></a>order by … desc limit 1</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> (<span class="keyword">analyze</span>, buffers, costs) </span><br><span class="line"><span class="keyword">select</span> login_date </span><br><span class="line"><span class="keyword">from</span> user_login_record </span><br><span class="line"><span class="keyword">where</span> user_id=<span class="string">&#x27;952bd155-06b3-4792-82ec-4b86d06c86a7&#x27;</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> login_date <span class="keyword">desc</span> </span><br><span class="line"><span class="keyword">limit</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">                                                                    QUERY PLAN                                                                    </span><br><span class="line">--------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> Limit  (cost&#x3D;0.41..0.44 rows&#x3D;1 width&#x3D;8) (actual time&#x3D;0.036..0.036 rows&#x3D;1 loops&#x3D;1)</span><br><span class="line">   Buffers: shared hit&#x3D;4</span><br><span class="line">   -&gt;  Index Only Scan using user_login_date on user_login_record  (cost&#x3D;0.41..30.06 rows&#x3D;1077 width&#x3D;8) (actual time&#x3D;0.034..0.035 rows&#x3D;1 loops&#x3D;1)</span><br><span class="line">         Index Cond: (user_id &#x3D; &#39;952bd155-06b3-4792-82ec-4b86d06c86a7&#39;::bpchar)</span><br><span class="line">         Heap Fetches: 0</span><br><span class="line">         Buffers: shared hit&#x3D;4</span><br><span class="line"> Planning Time: 0.067 ms</span><br><span class="line"> Execution Time: 0.049 ms</span><br><span class="line">(8 rows)</span><br></pre></td></tr></table></figure>

<h4 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h4><p>两个都利用了索引的 login_date 字段，只取了最后一条参与计算，但是max多了一个循环，速度略差。</p>
<h3 id="比较-II（where中包含三个字段）"><a href="#比较-II（where中包含三个字段）" class="headerlink" title="比较 II（where中包含三个字段）"></a>比较 II（where中包含三个字段）</h3><p>两个字读的状况我也测试比较过，和一个字段情形相同，max 查询也利用了索引，只取了最后一条，也是多了一个循环。  单独拿出来3个字段，是因为3个字段的结果和1-2个字段不同。</p>
<h3 id="环境-1"><a href="#环境-1" class="headerlink" title="环境"></a>环境</h3><p>table</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> user_login_record(</span><br><span class="line">  <span class="keyword">group_id</span>       <span class="built_in">char</span>(<span class="number">36</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">  user_id         <span class="built_in">char</span>(<span class="number">36</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">  machine_id   <span class="built_in">char</span>(<span class="number">32</span>) <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">  login_date    <span class="built_in">timestamp</span>  <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>上面这个表有4个字段，相比之前多了group_id, machine_id，可以理解为用户在某个组内用某台机器登陆的记录。我们根据 group_id, user_id和machine_id 来查询最后一个 login_date</p>
<p>依旧直接建立索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> user_login_date <span class="keyword">on</span> user_login_record (<span class="keyword">group_id</span>, user_id, machine_id, login_date <span class="keyword">desc</span>);</span><br></pre></td></tr></table></figure>


<h3 id="比较结果-1"><a href="#比较结果-1" class="headerlink" title="比较结果"></a>比较结果</h3><h4 id="max-1"><a href="#max-1" class="headerlink" title="max"></a>max</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> (<span class="keyword">analyze</span>, buffers, costs) </span><br><span class="line"><span class="keyword">select</span> <span class="keyword">max</span>(login_date) </span><br><span class="line"><span class="keyword">from</span> user_login_record </span><br><span class="line"><span class="keyword">where</span> <span class="keyword">group_id</span>=<span class="string">&#x27;312bb069-fd27-4822-885d-c3ac67bfd8a1&#x27;</span> </span><br><span class="line">  <span class="keyword">and</span> user_id=<span class="string">&#x27;952bd155-06b3-4792-82ec-4b86d06c86a7&#x27;</span> </span><br><span class="line">  <span class="keyword">and</span> machine_id=<span class="string">&#x27;C635F8F44F1960778CE58869DF10150D&#x27;</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">                                                                                                   QUERY PLAN                                                                                                   </span><br><span class="line">----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> Aggregate  (cost&#x3D;2.84..2.85 rows&#x3D;1 width&#x3D;8) (actual time&#x3D;0.143..0.143 rows&#x3D;1 loops&#x3D;1)</span><br><span class="line">   Buffers: shared hit&#x3D;72</span><br><span class="line">   -&gt;  Index Only Scan using user_login_date on user_login_record  (cost&#x3D;0.41..2.84 rows&#x3D;1 width&#x3D;8) (actual time&#x3D;0.050..0.126 rows&#x3D;98 loops&#x3D;1)</span><br><span class="line">         Index Cond: ((group_id &#x3D; &#39;312bb069-fd27-4822-885d-c3ac67bfd8a1&#39;::bpchar) AND (user_id &#x3D; &#39;952bd155-06b3-4792-82ec-4b86d06c86a7&#39;::bpchar) AND (machine_id &#x3D; &#39;C635F8F44F1960778CE58869DF10150D&#39;::bpchar))</span><br><span class="line">         Heap Fetches: 98</span><br><span class="line">         Buffers: shared hit&#x3D;72</span><br><span class="line"> Planning Time: 0.139 ms</span><br><span class="line"> Execution Time: 0.163 ms</span><br><span class="line">(8 rows)</span><br></pre></td></tr></table></figure>

<h4 id="order-by-…-desc-limit-1-1"><a href="#order-by-…-desc-limit-1-1" class="headerlink" title="order by … desc limit 1"></a>order by … desc limit 1</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> (<span class="keyword">analyze</span>, buffers, costs) </span><br><span class="line"><span class="keyword">select</span> login_date</span><br><span class="line"><span class="keyword">from</span> user_login_record </span><br><span class="line"><span class="keyword">where</span> <span class="keyword">group_id</span>=<span class="string">&#x27;312bb069-fd27-4822-885d-c3ac67bfd8a1&#x27;</span> </span><br><span class="line">  <span class="keyword">and</span> user_id=<span class="string">&#x27;952bd155-06b3-4792-82ec-4b86d06c86a7&#x27;</span> </span><br><span class="line">  <span class="keyword">and</span> machine_id=<span class="string">&#x27;C635F8F44F1960778CE58869DF10150D&#x27;</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> login_date <span class="keyword">desc</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">                                                                                                 QUERY PLAN                                                                                                   </span><br><span class="line">----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> Limit  (cost&#x3D;0.41..2.84 rows&#x3D;1 width&#x3D;8) (actual time&#x3D;0.042..0.042 rows&#x3D;1 loops&#x3D;1)</span><br><span class="line">   Buffers: shared hit&#x3D;4</span><br><span class="line">   -&gt;  Index Only Scan using user_login_date on user_login_record  (cost&#x3D;0.41..2.84 rows&#x3D;1 width&#x3D;8) (actual time&#x3D;0.041..0.041 rows&#x3D;1 loops&#x3D;1)</span><br><span class="line">         Index Cond: ((group_id &#x3D; &#39;312bb069-fd27-4822-885d-c3ac67bfd8a1&#39;::bpchar) AND (user_id &#x3D; &#39;952bd155-06b3-4792-82ec-4b86d06c86a7&#39;::bpchar) AND (machine_id &#x3D; &#39;C635F8F44F1960778CE58869DF10150D&#39;::bpchar))</span><br><span class="line">         Heap Fetches: 1</span><br><span class="line">         Buffers: shared hit&#x3D;4</span><br><span class="line"> Planning Time: 0.124 ms</span><br><span class="line"> Execution Time: 0.057 ms</span><br><span class="line">(8 rows)</span><br></pre></td></tr></table></figure>

<h4 id="结论-1"><a href="#结论-1" class="headerlink" title="结论"></a>结论</h4><p>两个都利用了索引，但利用方式有所不同，max没有利用login_date字段的排序，最后对符合条件的98条数据进行了筛选(rows=98 loops=1)；order by limit 1的sql则依旧利用了索引中的 login_date 字段，只取了一套数据(rows=1 loops=1)。<br>虽然这次max没多一次循环，但由于多了多条记录，相比另外一个sql性能降低了很多。</p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>随着PostgreSQL的升级（我的测试环境12和14版）以及不同环境的数据库会对sql采取不同优化措施。本文中的测试结果也可能会不同。每个人应该在自己的环境中做实际的测试来选择用那个sql以获得最佳的性能。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.devmgr.cn/2022/01/05/postgresql-now-%E5%87%BD%E6%95%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="GeXiangDong">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeXiangDong">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/05/postgresql-now-%E5%87%BD%E6%95%B0/" class="post-title-link" itemprop="url">PostgreSQL now()函数</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-05 17:08:10" itemprop="dateCreated datePublished" datetime="2022-01-05T17:08:10+08:00">2022-01-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-01-09 15:32:09" itemprop="dateModified" datetime="2022-01-09T15:32:09+08:00">2022-01-09</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>now()函数是postgresql 中用来获取当前时间的函数，需要注意postgresql提供了多个获取当时时间的函数，now只是其中一个。</p>
<table>
<thead>
<tr>
<th align="left">函数</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">now()</td>
<td align="left">事务的开始时间，等同于 transaction_timestamp()</td>
</tr>
<tr>
<td align="left">transaction_timestamp()</td>
<td align="left">事务的开始时间，等同于now()，同一事务内多次调用返回相同个结果</td>
</tr>
<tr>
<td align="left">statement_timestamp()</td>
<td align="left">语句的开始执行时间，同一语句内多次调用结果相同</td>
</tr>
<tr>
<td align="left">clock_timestamp()</td>
<td align="left">时钟时间，如果一个SQL语句多次调用（例如有子查询）返回结果可能不同</td>
</tr>
</tbody></table>
<p>根据上述说明，如果需要用timestamp字段排序，且顺序非常重要，例如余额变化，然后一个事务中可能有多个insert，用now()就会造成混乱。</p>
<p>可以通过sql测试下这几个函数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">now</span>(), pg_sleep(<span class="number">0.1</span>), transaction_timestamp() , pg_sleep(<span class="number">0.1</span>), statement_timestamp(),  pg_sleep(<span class="number">0.1</span>), clock_timestamp(), pg_sleep(<span class="number">0.1</span>), statement_timestamp(), clock_timestamp();</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">now</span>(), pg_sleep(<span class="number">0.1</span>), transaction_timestamp() , pg_sleep(<span class="number">0.1</span>), statement_timestamp(),  pg_sleep(<span class="number">0.1</span>), clock_timestamp(), pg_sleep(<span class="number">0.1</span>), statement_timestamp(), clock_timestamp();</span><br><span class="line"><span class="keyword">commit</span>;</span><br></pre></td></tr></table></figure>

<p>在PSQL内执行上面的SQL，会得到如下结果，从结果中可以看到，一个事务内，多个sql的多次now() transaction_timestamp()返回的结果是完全相同的；同一事务内多个语句中的statement_timestamp()返回结果不同，而同一语句中的statement_timestamp()返回结果相同；任意一个clock_timestamp()返回结果都可能不同（pg_sleep(0.1)是让postgresql睡眠0.1秒后继续执行）</p>
<pre><code>tempdb =# begin;
BEGIN
tempdb =*# select now(), pg_sleep(0.1), transaction_timestamp(), pg_sleep(0.1), statement_timestamp(),  pg_sleep(0.1), clock_timestamp(), pg_sleep(0.1), statement_timestamp(), clock_timestamp();
              now              | pg_sleep |     transaction_timestamp     | pg_sleep |     statement_timestamp      | pg_sleep |        clock_timestamp        | pg_sleep |     statement_timestamp      |        clock_timestamp        
-------------------------------+----------+-------------------------------+----------+------------------------------+----------+-------------------------------+----------+------------------------------+-------------------------------
 2022-01-09 15:27:28.976989+08 |          | 2022-01-09 15:27:28.976989+08 |          | 2022-01-09 15:27:34.43345+08 |          | 2022-01-09 15:27:34.737544+08 |          | 2022-01-09 15:27:34.43345+08 | 2022-01-09 15:27:34.838665+08
(1 row)

tempdb=*# select now(), pg_sleep(0.1), transaction_timestamp(), pg_sleep(0.1), statement_timestamp(),  pg_sleep(0.1), clock_timestamp(), pg_sleep(0.1), statement_timestamp(), clock_timestamp();
              now              | pg_sleep |     transaction_timestamp     | pg_sleep |      statement_timestamp      | pg_sleep |       clock_timestamp        | pg_sleep |      statement_timestamp      |        clock_timestamp        
-------------------------------+----------+-------------------------------+----------+-------------------------------+----------+------------------------------+----------+-------------------------------+-------------------------------
 2022-01-09 15:27:28.976989+08 |          | 2022-01-09 15:27:28.976989+08 |          | 2022-01-09 15:27:43.321314+08 |          | 2022-01-09 15:27:43.62673+08 |          | 2022-01-09 15:27:43.321314+08 | 2022-01-09 15:27:43.727897+08
(1 row)

tempdb=*# commit;
COMMIT</code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.devmgr.cn/2021/12/31/%E4%B8%80%E6%AC%A1java-lang-outofmemoryerror%E5%BC%82%E5%B8%B8%E7%9A%84%E6%8E%92%E6%9F%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="GeXiangDong">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeXiangDong">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/31/%E4%B8%80%E6%AC%A1java-lang-outofmemoryerror%E5%BC%82%E5%B8%B8%E7%9A%84%E6%8E%92%E6%9F%A5/" class="post-title-link" itemprop="url">一次java.lang.OutOfMemoryError异常的排查</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-12-31 15:30:18 / 修改时间：16:09:44" itemprop="dateCreated datePublished" datetime="2021-12-31T15:30:18+08:00">2021-12-31</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>服务器上抛出了异常，java.lang.OutOfMemoryError，这种异常比较难解决，因为有可能大量占用内存的地方并不是抛出异常的位置，抛异常处可能是正常使用内存，只是内存没了。</p>
<pre><code>java.lang.OutOfMemoryError: unable to create native thread: possibly out of memory or process/resource limits reached
        at java.base/java.lang.Thread.start0(Native Method)
        at java.base/java.lang.Thread.start(Thread.java:798)
        at me.chanjar.weixin.common.api.WxMessageInMemoryDuplicateChecker.checkBackgroundProcessStarted(WxMessageInMemoryDuplicateChecker.java:81)
        at me.chanjar.weixin.common.api.WxMessageInMemoryDuplicateChecker.isDuplicate(WxMessageInMemoryDuplicateChecker.java:89)
        at me.chanjar.weixin.mp.api.WxMpMessageRouter.isMsgDuplicated(WxMpMessageRouter.java:257)
        at me.chanjar.weixin.mp.api.WxMpMessageRouter.route(WxMpMessageRouter.java:172)
        at me.chanjar.weixin.open.api.impl.WxOpenMessageRouter.route(WxOpenMessageRouter.java:24)
        at me.chanjar.weixin.open.api.impl.WxOpenMessageRouter.route(WxOpenMessageRouter.java:20)
        at cn.devmgr.mall.wechatopen.WechatNotifyController.callback(WechatNotifyController.java:269)
        at jdk.internal.reflect.GeneratedMethodAccessor433.invoke(Unknown Source)
        at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
        at java.base/java.lang.reflect.Method.invoke(Method.java:566)
          ... ...</code></pre>
<p>首先在抛出这种异常后，我先查看了下服务器的内存（之前已经写好的查询实例内存的接口），返回信息如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;memory&quot;: &#123;</span><br><span class="line">  &quot;total&quot;: 161480704,</span><br><span class="line">  &quot;max&quot;: 536870912,</span><br><span class="line">  &quot;free&quot;: 50741880</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个结果说明了不是内存不足，实际上内存不足的exception一般是 <code>java.lang.OutOfMemoryError: Java heap space</code>，而这次的是 <code>java.lang.OutOfMemoryError: unable to create native thread: possibly out of memory or process/resource limits reached</code><br>所以判断 process/resource limits reached 引发的。</p>
<p>于是写了段代码查询当前实例的线程数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Thread t : Thread.getAllStackTraces().keySet()) &#123;</span><br><span class="line">  <span class="comment">// 统计每个线程的信息</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现抛出异常时，waiting状态的线程甚至达到了6000多个，这肯定是有些线程没有结束导致，查询自己的代码，没有搜到new Thread()，应该是调用其他类库不当导致，要找出原因还得写监控程序。</p>
<p>于是开始统计实例那所有的线程堆栈信息（这个异常虽然不容易重现，但可较容易观察到线程数量增常，这给查找原因带来了方便）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Thread t : Thread.getAllStackTraces().keySet()) &#123;</span><br><span class="line">    StackTraceElement[] elements = t.getStackTrace();</span><br><span class="line">     <span class="comment">//  按照堆栈分组统计各个线程的数量</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>按照堆栈分组，我采用的办法是把每个StackTraceElement的className, methodName, lineNumber拼接成一个字符串，用这个字符串作为key，判断是否属于一组线程。</p>
<p>发现了如下这个堆栈对应的线程数很多，且呈现出随时间增长不减退的趋势：</p>
<pre><code>jdk.internal.misc.Unsafepark(Unsafe.java:-2)
java.util.concurrent.locks.LockSupportpark(LockSupport.java:194)
java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObjectawait(AbstractQueuedSynchronizer.java:2081)
java.util.concurrent.LinkedBlockingQueuetakeLinked(BlockingQueue.java:433)
java.util.concurrent.ThreadPoolExecutorgetTask(ThreadPoolExecutor.java:1054)
java.util.concurrent.ThreadPoolExecutorrunWorker(ThreadPoolExecutor.java:1114)
java.util.concurrent.ThreadPoolExecutor$Workerrun(ThreadPoolExecutor.java:628)
java.lang.Threadrun(Thread.java:829)</code></pre>
<p>很遗憾的是，从这个堆栈里只能看出被创建了ThreadPoolExecutor，这个堆栈信息里所有类都是JDK的，没有任何第三方代码，还是没法知道是哪的程序。于是想找到线程的调用方，网上搜索到stackoverflow内有一个有趣的问答</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/18999444/how-to-find-out-who-create-a-thread-in-java">https://stackoverflow.com/questions/18999444/how-to-find-out-who-create-a-thread-in-java</a></p>
<p>在此贴 Aaron Digulla给出了7种方法来查找线程的调用方，7种，引用如下：</p>
<pre><code>Here is the list of approaches, sorted from quickest / most reliable to slowest / hardest:

1. If you have the source of the class, create an exception in the constructor (without actually throwing it). You can simply examine or print it when you need to know when the thread was created.
2. If you don&#39;t have the sources, the thread name can be a good hint who created it.
3. If the name hints to a generic service (like java.util.Timer), then you can create a conditional breakpoint in your IDE in the constructor. The condition should be the thread name; the debugger will then stop when someone creates a thread with this name.
4. If you don&#39;t have too many threads, set a breakpoint in the constructors of Thread.
5. If you have many threads, attach a debugger to the app and freeze it. Then examine the stack traces.
6. If everything else fails, get the source code for the Java runtime and add logging code in the classes you want to observe, compile a new rt.jar and replace the original one with your version. Don&#39;t try this in production, please.
7. If money isn&#39;t an issue, you can use dynamic tracing tools like Compuware APM or, if you&#39;re on Linux or Solaris, you can try SystemTap and dtrace, respectively.</code></pre>
<p>我采用了第2种，修改了查询所有线程堆栈的地方，增加了线程名字，然后继续监控，发现了线程名就是一个第三方类库的类名，找到它源码，发现里面有new ExecutorService，而我代码多次new了这个类。修改代码，不再多次new它；部署后看监控程序 thread数目不再增长，解决。</p>
<h3 id="附录：此次排查中使用的完整的监控代码"><a href="#附录：此次排查中使用的完整的监控代码" class="headerlink" title="附录：此次排查中使用的完整的监控代码"></a>附录：此次排查中使用的完整的监控代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.zaxxer.hikari.HikariDataSource;</span><br><span class="line"><span class="keyword">import</span> com.zaxxer.hikari.HikariPoolMXBean;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/service-status&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceStatusController</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(ServiceStatusController.class);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired(required = false)</span></span><br><span class="line">  <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Value(&quot;$&#123;spring.application.name:no_name&#125;&quot;)</span></span><br><span class="line">  <span class="keyword">private</span> String appName;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@GetMapping</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getStatus</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    result.put(<span class="string">&quot;applicationName&quot;</span>, appName);</span><br><span class="line">    Map&lt;String, Object&gt; memory = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    Runtime rt = Runtime.getRuntime();</span><br><span class="line">    memory.put(<span class="string">&quot;total&quot;</span>, rt.totalMemory());</span><br><span class="line">    memory.put(<span class="string">&quot;free&quot;</span>, rt.freeMemory());</span><br><span class="line">    memory.put(<span class="string">&quot;max&quot;</span>, rt.maxMemory());</span><br><span class="line">    result.put(<span class="string">&quot;memory&quot;</span>, memory);</span><br><span class="line">    result.put(<span class="string">&quot;availableProcessors&quot;</span>, rt.availableProcessors());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dataSource != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (dataSource <span class="keyword">instanceof</span> HikariDataSource) &#123;</span><br><span class="line">        HikariDataSource hds = (HikariDataSource) dataSource;</span><br><span class="line">        <span class="keyword">if</span> (hds.getHikariPoolMXBean() == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// 先获取一次才能取得 poolMXBean, 如果程序中有其他请求已经使用过数据库，则不需要这里的获取conn</span></span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            Connection conn = hds.getConnection();</span><br><span class="line">            conn.close();</span><br><span class="line">          &#125; <span class="keyword">catch</span> (SQLException sqlException) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;cannot get conn&quot;</span>, sqlException);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        HikariPoolMXBean pool = hds.getHikariPoolMXBean();</span><br><span class="line">        <span class="keyword">if</span> (pool != <span class="keyword">null</span>) &#123;</span><br><span class="line">          Map&lt;String, Object&gt; poolStatus = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">          poolStatus.put(<span class="string">&quot;active&quot;</span>, pool.getActiveConnections());</span><br><span class="line">          poolStatus.put(<span class="string">&quot;idle&quot;</span>, pool.getIdleConnections());</span><br><span class="line">          poolStatus.put(<span class="string">&quot;total&quot;</span>, pool.getTotalConnections());</span><br><span class="line">          poolStatus.put(<span class="string">&quot;awaiting&quot;</span>, pool.getThreadsAwaitingConnection());</span><br><span class="line">          poolStatus.put(<span class="string">&quot;maximumPoolSize&quot;</span>, hds.getMaximumPoolSize());</span><br><span class="line">          poolStatus.put(<span class="string">&quot;minimumIdle&quot;</span>, hds.getMinimumIdle());</span><br><span class="line">          poolStatus.put(<span class="string">&quot;idleTimeout&quot;</span>, hds.getIdleTimeout());</span><br><span class="line">          result.put(<span class="string">&quot;dataSourcePool&quot;</span>, poolStatus);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;datasource is not hikari&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      logger.info(<span class="string">&quot;no datasource&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">      Map&lt;String, Integer&gt; threadsStatus = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">      <span class="keyword">for</span> (Thread t : Thread.getAllStackTraces().keySet()) &#123;</span><br><span class="line">        String key = t.getState().toString().toLowerCase();</span><br><span class="line">        Integer cnt = threadsStatus.get(key);</span><br><span class="line">        <span class="keyword">if</span> (cnt == <span class="keyword">null</span>) &#123;</span><br><span class="line">          threadsStatus.put(key, <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          threadsStatus.put(key, cnt + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      threadsStatus.put(<span class="string">&quot;total&quot;</span>, Thread.getAllStackTraces().size());</span><br><span class="line">      result.put(<span class="string">&quot;threads&quot;</span>, threadsStatus);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@GetMapping(&quot;/threads&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> Map&lt;String, ?&gt; getThreadStackTraces() &#123;</span><br><span class="line">    logger.trace(<span class="string">&quot;getThreadStackTraces&quot;</span>);</span><br><span class="line">    Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    Map&lt;String, Map&lt;String, Object&gt;&gt; threadInfoByKey = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Thread t : Thread.getAllStackTraces().keySet()) &#123;</span><br><span class="line">      StackTraceElement[] elements = t.getStackTrace();</span><br><span class="line">      List&lt;Map&lt;String, Object&gt;&gt; stackList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">      StringBuilder builder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">      <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> (StackTraceElement ele : elements) &#123;</span><br><span class="line">        i++;</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;className&quot;</span>, ele.getClassName());</span><br><span class="line">        map.put(<span class="string">&quot;methodName&quot;</span>, ele.getMethodName());</span><br><span class="line">        map.put(<span class="string">&quot;lineNum&quot;</span>, ele.getLineNumber());</span><br><span class="line">        map.put(<span class="string">&quot;fileName&quot;</span>, ele.getFileName());</span><br><span class="line">        map.put(<span class="string">&quot;module&quot;</span>, ele.getModuleName());</span><br><span class="line">        stackList.add(map);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="number">30</span>) &#123;</span><br><span class="line">          builder.append(ele.getClassName());</span><br><span class="line">          builder.append(ele.getMethodName());</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      String status = t.getState().toString().toLowerCase();</span><br><span class="line">      String key = builder.toString();</span><br><span class="line">      Map&lt;String, Object&gt; threadInfo = threadInfoByKey.get(key);</span><br><span class="line">      <span class="keyword">if</span> (threadInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">        threadInfo = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        threadInfo.put(<span class="string">&quot;stack&quot;</span>, stackList);</span><br><span class="line">        threadInfoByKey.put(key, threadInfo);</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; list = result.get(status);</span><br><span class="line">        <span class="keyword">if</span> (list == <span class="keyword">null</span>) &#123;</span><br><span class="line">          list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">          result.put(status, list);</span><br><span class="line">        &#125;</span><br><span class="line">        list.add(threadInfo);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (threadInfo.containsKey(<span class="string">&quot;counter&quot;</span>)) &#123;</span><br><span class="line">        threadInfo.put(<span class="string">&quot;counter&quot;</span>, (Integer) threadInfo.get(<span class="string">&quot;counter&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        threadInfo.put(<span class="string">&quot;counter&quot;</span>, <span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (threadInfo.containsKey(<span class="string">&quot;names&quot;</span>)) &#123;</span><br><span class="line">        List&lt;String&gt; names = (List&lt;String&gt;) threadInfo.get(<span class="string">&quot;names&quot;</span>);</span><br><span class="line">        names.add(t.getName());</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        List&lt;String&gt; names = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        names.add(t.getName());</span><br><span class="line">        threadInfo.put(<span class="string">&quot;names&quot;</span>, names);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.devmgr.cn/2021/12/07/spring-boot%E4%B8%AD%E8%8E%B7%E5%8F%96%E8%BF%9E%E6%8E%A5%E6%B1%A0%E4%BD%BF%E7%94%A8%E7%8A%B6%E5%86%B5%EF%BC%88%E5%BD%93%E5%89%8D%E6%B4%BB%E5%8A%A8%E8%BF%9E%E6%8E%A5%E6%95%B0%E7%AD%89%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="GeXiangDong">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeXiangDong">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/07/spring-boot%E4%B8%AD%E8%8E%B7%E5%8F%96%E8%BF%9E%E6%8E%A5%E6%B1%A0%E4%BD%BF%E7%94%A8%E7%8A%B6%E5%86%B5%EF%BC%88%E5%BD%93%E5%89%8D%E6%B4%BB%E5%8A%A8%E8%BF%9E%E6%8E%A5%E6%95%B0%E7%AD%89%EF%BC%89/" class="post-title-link" itemprop="url">spring boot中获取连接池使用状况（当前活动连接数等）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-12-07 14:32:00 / 修改时间：15:06:03" itemprop="dateCreated datePublished" datetime="2021-12-07T14:32:00+08:00">2021-12-07</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>spring boot (2.2.x) 中默认使用hikariCP作为连接池，配置如下</p>
<p>applicaiton.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driverClassName:</span> <span class="string">org.postgresql.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:postgresql://db-server:5433/mydb</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">pgdbo</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">sql</span></span><br><span class="line">    <span class="attr">hikari:</span></span><br><span class="line">      <span class="attr">maximum-pool-size:</span> <span class="number">20</span> <span class="comment">#最多20个连接</span></span><br><span class="line">      <span class="attr">minimum-idle:</span> <span class="number">5</span>   <span class="comment"># 空闲时保持最小连接数</span></span><br><span class="line">      <span class="attr">idle-timeout:</span> <span class="number">10000</span>  <span class="comment"># 空闲连接存活时间</span></span><br><span class="line">      <span class="attr">connection-timeout:</span> <span class="number">8000</span> <span class="comment"># 连接超时时间</span></span><br><span class="line">      <span class="attr">connection-test-query:</span> <span class="string">select</span>  <span class="number">1</span>  <span class="comment"># 测试sql</span></span><br></pre></td></tr></table></figure>
<p>如果不配置，默认的超时时间10分钟，minimum-dile是10个</p>
<p>如果我们希望监视当前有多少个activeConnection，可以通过如下方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>  <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line"><span class="keyword">if</span> (dataSource <span class="keyword">instanceof</span> HikariDataSource) &#123;</span><br><span class="line">   HikariDataSource hds = (HikariDataSource) dataSource;</span><br><span class="line">   <span class="keyword">if</span> (hds.getHikariPoolMXBean() == <span class="keyword">null</span>) &#123;</span><br><span class="line">     <span class="comment">// 先获取一次才能取得 poolMXBean, 如果程序中有其他请求已经使用过数据库，则不需要这里的获取conn</span></span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">       Connection conn = hds.getConnection();</span><br><span class="line">       conn.close();</span><br><span class="line">     &#125; <span class="keyword">catch</span> (SQLException sqlException) &#123;</span><br><span class="line">       logger.error(<span class="string">&quot;cannot get conn&quot;</span>, sqlException);</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   HikariPoolMXBean pool = hds.getHikariPoolMXBean();</span><br><span class="line">   <span class="keyword">if</span> (pool != <span class="keyword">null</span>) &#123;</span><br><span class="line">     Map&lt;String, Object&gt; poolStatus = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">     poolStatus.put(<span class="string">&quot;active&quot;</span>, pool.getActiveConnections());</span><br><span class="line">     poolStatus.put(<span class="string">&quot;idle&quot;</span>, pool.getIdleConnections());</span><br><span class="line">     poolStatus.put(<span class="string">&quot;total&quot;</span>, pool.getTotalConnections());</span><br><span class="line">     poolStatus.put(<span class="string">&quot;awaiting&quot;</span>, pool.getThreadsAwaitingConnection());</span><br><span class="line">     poolStatus.put(<span class="string">&quot;maximumPoolSize&quot;</span>, hds.getMaximumPoolSize());</span><br><span class="line">     poolStatus.put(<span class="string">&quot;minimumIdle&quot;</span>, hds.getMinimumIdle());</span><br><span class="line">     poolStatus.put(<span class="string">&quot;idleTimeout&quot;</span>, hds.getIdleTimeout());</span><br><span class="line">     result.put(<span class="string">&quot;dataSourcePool&quot;</span>, poolStatus);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>注意第4到第12行那部分，如果连接池一次也没被执行过（获取过连接），那么getHikariPoolMXBean() 会返回null，无法获取信息，需要手工执行一次getConnection</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.devmgr.cn/2021/12/07/redis%E4%B8%AD%E5%AD%98%E5%82%A8pojo%EF%BC%8Cpojo%E5%A2%9E%E5%88%A0%E5%B1%9E%E6%80%A7%E5%90%8E%E9%87%8D%E6%96%B0%E9%83%A8%E7%BD%B2%EF%BC%8C%E6%9C%AA%E6%B8%85%E9%99%A4redis%E7%BC%93%E5%AD%98%E5%AF%BC%E8%87%B4%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%B1%E8%B4%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="GeXiangDong">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeXiangDong">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/07/redis%E4%B8%AD%E5%AD%98%E5%82%A8pojo%EF%BC%8Cpojo%E5%A2%9E%E5%88%A0%E5%B1%9E%E6%80%A7%E5%90%8E%E9%87%8D%E6%96%B0%E9%83%A8%E7%BD%B2%EF%BC%8C%E6%9C%AA%E6%B8%85%E9%99%A4redis%E7%BC%93%E5%AD%98%E5%AF%BC%E8%87%B4%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%B1%E8%B4%A5/" class="post-title-link" itemprop="url">Redis中存储POJO，POJO增删属性后重新部署，未清除Redis缓存导致的反序列化失败</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-12-07 14:07:55 / 修改时间：14:44:10" itemprop="dateCreated datePublished" datetime="2021-12-07T14:07:55+08:00">2021-12-07</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h2><p>使用spring boot的时候，缓存是常用的服务之一，放在缓存里的数据经常是个pojo，Java类放入缓存默认是通过序列化实现存储的。有时候升级改代码会增删一些属性，如果部署前忘记把相应的缓存先清除一下，就会遇到反序列化失败的异常了，异常信息一般如下：</p>
<pre><code>org.springframework.data.redis.serializer.SerializationException: Cannot deserialize; nested exception is org.springframework.core.serializer.support.SerializationFailedException: Failed to deserialize payload. Is the byte array a result of corresponding serialization for DefaultDeserializer?; nested exception is java.io.InvalidClassException: com.package-of-pojo.Xxxx; local class incompatible: stream classdesc serialVersionUID = -2364286648166609117, local class serialVersionUID = -8974455668551700477
    at org.springframework.data.redis.serializer.JdkSerializationRedisSerializer.deserialize(JdkSerializationRedisSerializer.java:84)
    at org.springframework.data.redis.serializer.DefaultRedisElementReader.read(DefaultRedisElementReader.java:48)
    at org.springframework.data.redis.serializer.RedisSerializationContext$SerializationPair.read(RedisSerializationContext.java:272)
    at org.springframework.data.redis.cache.RedisCache.deserializeCacheValue(RedisCache.java:260)
    at org.springframework.data.redis.cache.RedisCache.lookup(RedisCache.java:94)
    at org.springframework.cache.support.AbstractValueAdaptingCache.get(AbstractValueAdaptingCache.java:58)
    at org.springframework.cache.interceptor.AbstractCacheInvoker.doGet(AbstractCacheInvoker.java:73)
    at org.springframework.cache.interceptor.CacheAspectSupport.findInCaches(CacheAspectSupport.java:554)
    at org.springframework.cache.interceptor.CacheAspectSupport.findCachedItem(CacheAspectSupport.java:519)
    at org.springframework.cache.interceptor.CacheAspectSupport.execute(CacheAspectSupport.java:401)
    at org.springframework.cache.interceptor.CacheAspectSupport.execute(CacheAspectSupport.java:345)
    at org.springframework.cache.interceptor.CacheInterceptor.invoke(CacheInterceptor.java:61)
    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:186)
    at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:747)
    at org.springframework.aop.interceptor.ExposeInvocationInterceptor.invoke(ExposeInvocationInterceptor.java:93)
    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:186)
    at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:747)
    at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:689)</code></pre>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>遇到这种异常，一般很容易解决，使用 <code>redis-cli keys &#39;xxx*&#39; | xargs -n 1 redis-cli del</code> 这个命令去把所有的这个缓存查出来并且删了就好了。</p>
<p>但是这是一个很容易出现的问题，每次都手工去避免比较麻烦。是不是能够通过程序实现，如果遇到这种异常，自动清除redis内的对应内容并自动执行对应的方法，不从redis取了呢（例如 Cacheable 注解的方法，执行方法返回结果并将返回内容重新放入缓存服务器），这个思路是可行的，通过配置一个自定义的 CacheErrorHandler来实现。</p>
<h3 id="自定义的CacheErrorHandler"><a href="#自定义的CacheErrorHandler" class="headerlink" title="自定义的CacheErrorHandler"></a>自定义的CacheErrorHandler</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.Cache;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.interceptor.CacheErrorHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.serializer.support.SerializationFailedException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 此类处理过的异常，spring 不会再次抛出了，除非这里的代码里再次抛出 */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomCacheErrorHandler</span> <span class="keyword">implements</span> <span class="title">CacheErrorHandler</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(CustomCacheErrorHandler.class);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleCacheGetError</span><span class="params">(RuntimeException e, Cache cache, Object key)</span> </span>&#123;</span><br><span class="line">    logger.error(<span class="string">&quot;获取缓存数据时发生异常 cache-name: &#123;&#125;, cache-key:&#123;&#125;&quot;</span>, cache.getName(), key, e);</span><br><span class="line">    <span class="keyword">if</span> (e <span class="keyword">instanceof</span> SerializationFailedException) &#123;</span><br><span class="line">      logger.warn(<span class="string">&quot;序列化失败导致，清除该cache&quot;</span>);</span><br><span class="line">      cache.clear();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleCachePutError</span><span class="params">(RuntimeException e, Cache cache, Object o, Object key)</span> </span>&#123;</span><br><span class="line">    logger.error(<span class="string">&quot;handleCachePutError cache-name: &#123;&#125;, cache-key:&#123;&#125;&quot;</span>, cache.getName(), key, e);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleCacheEvictError</span><span class="params">(RuntimeException e, Cache cache, Object key)</span> </span>&#123;</span><br><span class="line">    logger.error(<span class="string">&quot;handleCacheEvictError cache-name: &#123;&#125;, cache-key:&#123;&#125;&quot;</span>, cache.getName(), key, e);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleCacheClearError</span><span class="params">(RuntimeException e, Cache cache)</span> </span>&#123;</span><br><span class="line">    logger.error(<span class="string">&quot;handleCacheClearError cache-name: &#123;&#125;, cache-key:&#123;&#125;&quot;</span>, cache.getName(), e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>spring在redis里存储的key都是 User:1111 User:2222 这种类型，其中 User 是cache的name， 1111 / 2222 则是key，当pojo反序列化失败时，所有cache-name相同的条目都失效了，所以17行有 cache.clear() 把整个cache都清除了；如果不写这行，则每个key执行一次，从结果上看也没问题。</p>
<h3 id="注册这个自定义个的CacheErrorHandler"><a href="#注册这个自定义个的CacheErrorHandler" class="headerlink" title="注册这个自定义个的CacheErrorHandler"></a>注册这个自定义个的CacheErrorHandler</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheErrorHandlerConfig</span> <span class="keyword">extends</span> <span class="title">CachingConfigurerSupport</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(CacheErrorHandlerConfig.class);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> CacheErrorHandler <span class="title">errorHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CustomCacheErrorHandler();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.devmgr.cn/2021/12/01/postgresql%E4%B8%BB%E4%BB%8E-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="GeXiangDong">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeXiangDong">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/01/postgresql%E4%B8%BB%E4%BB%8E-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" class="post-title-link" itemprop="url">PostgreSQL主从+负载均衡</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-01 10:16:20" itemprop="dateCreated datePublished" datetime="2021-12-01T10:16:20+08:00">2021-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-12-24 14:12:54" itemprop="dateModified" datetime="2021-12-24T14:12:54+08:00">2021-12-24</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>PostgreSQL的读写分离是通过2部分实现的</p>
<ol>
<li>主从集群（可以一主多从）</li>
<li>Pgpool-II 代理来分发读写操作到不同服务器</li>
</ol>
<p>Pgpool-II 功能强大，还可实现一个表/数据库分发到不同服务器上等等，此处不做讨论</p>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>三台服务器（可以把以下3个服务安装到一台，此处三台仅仅是为表达清晰）</p>
<ul>
<li>Pgpool-II ， IP： 192.168.1.10</li>
<li>PostgreSQL 主服务器， IP: 192.168.1.11</li>
<li>PostgreSQL 从服务器,   IP: 192.168.1.12</li>
</ul>
<h2 id="集群环境搭建"><a href="#集群环境搭建" class="headerlink" title="集群环境搭建"></a>集群环境搭建</h2><h3 id="安装PostgreSQL"><a href="#安装PostgreSQL" class="headerlink" title="安装PostgreSQL"></a>安装PostgreSQL</h3><p> 分别在主从服务器（192.168.1.11, 192.168.1.12) 上安装PostgreSQL, <code>apt install postgresql</code></p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>以下操作主从两个服务器都需要</p>
<h4 id="设置可以从网络访问"><a href="#设置可以从网络访问" class="headerlink" title="设置可以从网络访问"></a>设置可以从网络访问</h4><p>修改 postgresql.conf 文件（如果apt安装且版本12，在/etc/postgresql/12/main/目录下）</p>
<p>更改 listen_addresses 修改为*或者自己的IP地址</p>
<h4 id="设置主从复制用户访问"><a href="#设置主从复制用户访问" class="headerlink" title="设置主从复制用户访问"></a>设置主从复制用户访问</h4><p>修改 pg_hba.conf，在末尾增加一行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">host    replication     all             192.168.1.1&#x2F;24         trust</span><br></pre></td></tr></table></figure>
<p>这行是信任本地网络上所有复制用操作的连接</p>
<h4 id="在从服务器上设置"><a href="#在从服务器上设置" class="headerlink" title="在从服务器上设置"></a>在从服务器上设置</h4><p>在从服务器（192.168.1.12）上配置复制， 修改 postgresql.conf 文件，找到 primary_conninfo, hot_standby, wal_level 并修改他们</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">primary_conninfo &#x3D; &#39;host&#x3D;192.168.1.11 port&#x3D;5432 user&#x3D;postgres password&#x3D;&#39;</span><br><span class="line">hot_standby &#x3D; on </span><br><span class="line">wal_level &#x3D; replica</span><br></pre></td></tr></table></figure>

<p><em>这几项不设置也行，下面的pg_basebackup命令会在main目录下生成相应的配置</em></p>
<p>192.168.1.11是主数据库服务器IP，postgres是连接用户名，password是密码，因为我设置了信任所有本地网络用户，所以这里没密码，这行要根据自己的环境修改。</p>
<p>停止从服务器上的postgresql服务  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop postgresql</span><br></pre></td></tr></table></figure>

<p>进入数据库所在目录（如果ubuntu, apt安装12版，在 /var/lib/postgresql/12），并删除main目录，之后运行pg_basebackup命令从主服务器拷贝数据库文件，最后别忘了把新的main目录改成postgresql的用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;var&#x2F;lib&#x2F;postgrewsql&#x2F;12</span><br><span class="line">rm -r main</span><br><span class="line">pg_basebackup -h 192.168.1.11 -p 5432 -U postgres  -Fp -Xs -Pv -R -D .&#x2F;main</span><br><span class="line">chown -R postgres:postgres main</span><br></pre></td></tr></table></figure>

<p>如果pg_basebackup命令成功，会出现类似提示</p>
<pre><code>pg_basebackup: initiating base backup, waiting for checkpoint to complete
pg_basebackup: checkpoint completed
pg_basebackup: write-ahead log start point: 0/4000028 on timeline 1
pg_basebackup: starting background WAL receiver
pg_basebackup: created temporary replication slot &quot;pg_basebackup_8071&quot;
32514/32514 kB (100%), 1/1 tablespace                                         
pg_basebackup: write-ahead log end point: 0/4000100
pg_basebackup: waiting for background process to finish streaming ...
pg_basebackup: syncing data to disk ...
pg_basebackup: base backup completed</code></pre>
<p>并且在main目录下有一个 standby.signal 文件</p>
<p>之后启用postgresql</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start postgresql</span><br></pre></td></tr></table></figure>

<p>这时，可以用psql连接到从服务器，进行以下测试了，正确的结果应该是查询的sql都没问题，更新的sql不能执行了，会提示事务是只读的。<br>也可以执行<code>select pg_is_in_recovery();</code>应该返回T，表示服务器处于恢复模式</p>
<h3 id="其他配置（和主从无关）"><a href="#其他配置（和主从无关）" class="headerlink" title="其他配置（和主从无关）"></a>其他配置（和主从无关）</h3><p>仅仅为主从可忽略此部分</p>
<h4 id="postgresql-conf"><a href="#postgresql-conf" class="headerlink" title="postgresql.conf"></a>postgresql.conf</h4><ul>
<li>max_connections 默认为100，可根据需要增大最大连接数；<em>从服务器的最大连接数不能小于主服务器，否则会启动失败</em></li>
<li>shared_buffers  在独立的数据库服务器上一般设置为物理内存的1/4</li>
<li>work_mem增大则对单个SQL的排序等效果明显</li>
</ul>
<h4 id="pg-hba-conf"><a href="#pg-hba-conf" class="headerlink" title="pg_hba.conf"></a>pg_hba.conf</h4><p>可根据需要设置允许网络上某个用户连接及连接方式，例如把本地网络连接都允许且设置为trust，则可免去每次都输入密码的麻烦</p>
<h2 id="负载均衡，Pgpool-II-搭建"><a href="#负载均衡，Pgpool-II-搭建" class="headerlink" title="负载均衡，Pgpool-II 搭建"></a>负载均衡，Pgpool-II 搭建</h2><p>以下操作都在 Pgpool-II （192.168.1.10）服务器上操作</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install pgpool2</span><br></pre></td></tr></table></figure>

<h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><h3 id="修改-etc-pgpool2-pgpool-conf-文件"><a href="#修改-etc-pgpool2-pgpool-conf-文件" class="headerlink" title="修改 /etc/pgpool2/pgpool.conf 文件"></a>修改 /etc/pgpool2/pgpool.conf 文件</h3><h4 id="数据库节点配置"><a href="#数据库节点配置" class="headerlink" title="数据库节点配置"></a>数据库节点配置</h4><p>默认代理端口号是5433，可根据需要修改</p>
<p>增加2个节点，找到 backend_hostname0部分，按照下面内容修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">backend_hostname0 &#x3D; &#39;192.168.1.11&#39;</span><br><span class="line">backend_port0 &#x3D; 5432</span><br><span class="line">backend_weight0 &#x3D; 1</span><br><span class="line"></span><br><span class="line">backend_hostname1 &#x3D; &#39;192.168.1.12&#39;</span><br><span class="line">backend_port1 &#x3D; 5432</span><br><span class="line">backend_weight1 &#x3D; 1</span><br><span class="line"></span><br><span class="line">replication_mode &#x3D; off</span><br><span class="line"></span><br><span class="line">load_balance_mode &#x3D; on</span><br><span class="line"></span><br><span class="line">master_slave_mode &#x3D; on</span><br></pre></td></tr></table></figure>

<p>replication_mode 要设置成off。如果设置on，是由pgpool做复制操作，它会把所有更改SQL发送到每个节点，每个节点都执行一份，当有节点离线时，不会自动在上线后重发，需要设置很多东西，比较麻烦，所以还是用上面的postgresql自己内置的replication机制。</p>
<p>load_balance_mode 可是实现查询操作的负载均衡，如果off，所有sql都在backend0执行，如果on则根据 backend_weight权重比例来分配查询sql</p>
<p>master_slave_mode  指定服务器采用主从模式，backend0为主</p>
<h4 id="pgpool-管理用配置"><a href="#pgpool-管理用配置" class="headerlink" title="pgpool 管理用配置"></a>pgpool 管理用配置</h4><p>pgpool通过一系列pcp命令来维护/管理各个backend node（节点），默认管理端口时9898，如需修改在pgpool.conf内修改 pcp_port， 也可修改pcp_listen_addresses来允许远程管理</p>
<p>首先需要给pcp管理创建一个用户，通过修改pcp.conf实现，例如增加一行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pcp:ac5c74b64b4b8352ef2f181affb5ac2a</span><br></pre></td></tr></table></figure>

<p>则增加了一个用户，用户名pcp，密码sql（密码存储的是md5值）</p>
<h3 id="backend-node-的状态"><a href="#backend-node-的状态" class="headerlink" title="backend node 的状态"></a>backend node 的状态</h3><p>节点的状态维护并不是默认自动的，需要使用pcp命令来管理</p>
<p>除了backend0外，其他新增节点默认是 unused 状态，需要用pcp_attach_node改变状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pcp_attach_node -U pcp -p 9898 -h 127.0.0.1 1</span><br></pre></td></tr></table></figure>
<p>pcp_attach_node 用于把节点状态变为可用，最后一个1是节点序号，在pgpool.conf设置backend时的需要，也可以用sql命令<code>show pool_nodes</code>查到。</p>
<p>成功执行pcp_attach_node后，如果连接节点没问题，节点状态会变更为 up，否则为down</p>
<p>每个down/unused状态不会自动变为up</p>
<p>up也不会自动变为down，这在分发sql时就会出现问题，把sql分发到了已经停止服务的节点不是我们想要的，为了避免需要配置 health check</p>
<p>在pgpool.conf内做如下配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">health_check_period &#x3D; 10    #单位秒</span><br><span class="line">health_check_timeout &#x3D; 20</span><br><span class="line">health_check_user &#x3D; &#39;postgres&#39;</span><br><span class="line">health_check_pass &#x3D; &#39;&#39;</span><br><span class="line">health_check_database &#x3D; &#39;tempdb&#39;    </span><br></pre></td></tr></table></figure>
<p>需要把用户名、密码、数据等配制成自己环境所需，之后重启，pgpool就可以检查每个节点的状态是否依旧在线了，如果已经连接不到，则会自动变成down状态</p>
<p> (down, unused) =&gt; up 通过 pcp_attach_node </p>
<h2 id="pgpool-配置中的2个参数"><a href="#pgpool-配置中的2个参数" class="headerlink" title="pgpool 配置中的2个参数"></a>pgpool 配置中的2个参数</h2><h3 id="num-init-children"><a href="#num-init-children" class="headerlink" title="num_init_children"></a>num_init_children</h3><p>num_init_children 这个项目是启动多少个线程来接收pgpool的客户端（一般是我门开发的程序）的连接，当连接数超过这个值时，客户端就会等待直到有连接释放出来或者超时。</p>
<p>如果不使用pgpool时，直接连接postgresql，与postgresql的max_connections类似（在这个数目内都能正常连接，超过这个数就不正常了，区别是超过这个数后，连接postgresql的自动断了，连接pgpool的会进入等待队列）</p>
<p>默认值：100</p>
<p>如果自己的程序中使用了连接池，那么连接池的最大连接数不要超过这个值。</p>
<h3 id="max-pool"><a href="#max-pool" class="headerlink" title="max_pool"></a>max_pool</h3><p>这个有点特殊，和postgresql中没有对应的项目。它是每一个连接（num_init_children的每个线程）可以对应的往pgpool的 backend node的连接池数，如果使用多个数据库，这个一般设置成常用的数据库数目。让每个线程都有到每个数据库的连接池，这样速度最快。但要注意  num_init_children * max_pool 应该小于等于 backend node的max_connections</p>
<p>默认值：4</p>
<p>如果服务器上仅仅有一个数据库是用于生产的，那么改成1是个不错的选择。</p>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="ERROR-canceling-statement-due-to-conflict-with-recovery"><a href="#ERROR-canceling-statement-due-to-conflict-with-recovery" class="headerlink" title="ERROR: canceling statement due to conflict with recovery"></a>ERROR: canceling statement due to conflict with recovery</h3><p>  ERROR: canceling statement due to conflict with recovery<br>  Detail: User query might have needed to see row versions that must be removed.</p>
<h4 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h4><p>产生这个错误的原因是：sql在从服务器上执行，但执行时间较长，执行过程中从服务器从主服务器同步数据，更改了sql中的数据。</p>
<h4 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h4><p>以下几个办法都行</p>
<ol>
<li>优化sql，缩短执行时间，这是最好的办法</li>
<li>设置 hot_standby_feedback = on </li>
<li>增大 max_standby_archive_delay max_standby_streaming_delay 两个参数的值</li>
<li>把查询放到主服务器执行</li>
</ol>
<p>2和3都有些缺点，2会增加主服务器负担，3会加大从服务器和主服务器之间数据差异。<br>法4则失去了负载均衡的价值。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.devmgr.cn/2021/11/10/java-graphics2d-%E7%94%BB%E4%B8%80%E4%B8%AA%E9%80%8F%E6%98%8E%E7%9A%84%E5%9C%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="GeXiangDong">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeXiangDong">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/11/10/java-graphics2d-%E7%94%BB%E4%B8%80%E4%B8%AA%E9%80%8F%E6%98%8E%E7%9A%84%E5%9C%86/" class="post-title-link" itemprop="url">java Graphics2D 画一个透明的圆，在现有图片上镂空一部分</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-11-10 17:08:23" itemprop="dateCreated datePublished" datetime="2021-11-10T17:08:23+08:00">2021-11-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-10-25 07:36:12" itemprop="dateModified" datetime="2022-10-25T07:36:12+08:00">2022-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>首先这个标题不准确，需要的结果类似下图，注意中间圆形部分是透明的</p>
<h2 id="镂空一个圆形"><a href="#镂空一个圆形" class="headerlink" title="镂空一个圆形"></a>镂空一个圆形</h2><p><img src="https://raw.githubusercontent.com/gexiangdong/gexiangdong.github.io/master/images/c.png" alt="circle-transpant"></p>
<p>Graphics2D提供方法clearRect，可以清除出一个矩形区域，但没有clearCircle或者clearArc, clearEllipse等，通过清除的来实现不太可能。</p>
<p>实现思路可从描画部分入手，使用 Graphics2D 的 setClip 方法，在描画前把那个要剪出来的圆排除在外。 参照如下代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Area a = <span class="keyword">new</span> Area(<span class="keyword">new</span> Rectangle(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1200</span>, <span class="number">1200</span>));</span><br><span class="line">Ellipse2D circle = <span class="keyword">new</span> Ellipse2D.Float(<span class="number">100</span>, <span class="number">100</span>, <span class="number">1000</span>, <span class="number">1000</span>);</span><br><span class="line">a.subtract(<span class="keyword">new</span> Area(circle));</span><br><span class="line">g.setClip(a);</span><br><span class="line">g.setColor(<span class="keyword">new</span> Color(<span class="number">255</span>, <span class="number">255</span>, <span class="number">192</span>));</span><br><span class="line">g.fillRect(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1200</span>, <span class="number">1200</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="金保留文字部分，其余部分镂空"><a href="#金保留文字部分，其余部分镂空" class="headerlink" title="金保留文字部分，其余部分镂空"></a>金保留文字部分，其余部分镂空</h2><p>把一张图除文字外的部分剔除掉，实现如下图所示效果</p>
<p><img src="https://raw.githubusercontent.com/gexiangdong/gexiangdong.github.io/master/images/d.png" alt="circle-transpant"></p>
<p>也是利用 graphics2d 的 setClip 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// g 是新图的graphics2D，目标图（对应上图右侧），bgImg是原图（对应上图左侧）</span></span><br><span class="line">FontRenderContext frc = g.getFontRenderContext();</span><br><span class="line">Font font = arial.deriveFont(Font.BOLD, <span class="number">260</span>);</span><br><span class="line">GlyphVector gv = font.createGlyphVector(frc, <span class="string">&quot;10&quot;</span>);</span><br><span class="line">Rectangle2D box = gv.getVisualBounds();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算文字轮廓放置位置（中央）</span></span><br><span class="line"><span class="keyword">int</span> xOff = (<span class="keyword">int</span>) (bgImg.getWidth() - box.getWidth()) / <span class="number">2</span>;</span><br><span class="line"><span class="keyword">int</span> yOff = (<span class="keyword">int</span>) (bgImg.getHeight() + box.getHeight()) / <span class="number">2</span>;</span><br><span class="line"><span class="comment">// xOff, yOff是文字轮廓左下角的坐标</span></span><br><span class="line">Shape shape = gv.getOutline(xOff, yOff);</span><br><span class="line">g.setClip(shape);</span><br><span class="line">g.drawImage(bgImg, <span class="number">0</span>, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">g.setClip(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上面的例子图形文字有边框，如果需要，可用如下方式描画边框</span></span><br><span class="line">g.setStroke(<span class="keyword">new</span> BasicStroke(<span class="number">1f</span>));</span><br><span class="line">g.setColor(Color.RED);</span><br><span class="line">g.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);</span><br><span class="line">g.draw(shape);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.devmgr.cn/2021/07/07/%E7%94%A8maven%E7%9A%84shade%E6%8F%92%E4%BB%B6%E6%89%93%E5%8C%85javafx%E9%A1%B9%E7%9B%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="GeXiangDong">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeXiangDong">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/07/%E7%94%A8maven%E7%9A%84shade%E6%8F%92%E4%BB%B6%E6%89%93%E5%8C%85javafx%E9%A1%B9%E7%9B%AE/" class="post-title-link" itemprop="url">用maven的shade插件打包javaFX项目</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-07-07 08:14:33 / 修改时间：08:50:32" itemprop="dateCreated datePublished" datetime="2021-07-07T08:14:33+08:00">2021-07-07</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="用maven的shade插件打包javaFX项目"><a href="#用maven的shade插件打包javaFX项目" class="headerlink" title="用maven的shade插件打包javaFX项目"></a>用maven的shade插件打包javaFX项目</h1><p>javaFX是java在2007年首次公布，可用于替代Java Swing、AWT 等图形界面的客户端UI框架。</p>
<p>java项目一般会被打包成一个jar，然后和依赖的jar一起发布，运行时要在classpath里指定出来各个依赖的jar。我们开发项目时一般用很多现成的轮子，依赖的jar很多。</p>
<p>maven的shade插件可以把依赖的jar一起打包到一个大jar中（这个jar体积会比较大），之后仅拷贝并运行一个jar就可以了，为使用提供了很多方便。</p>
<h2 id="使用-shade-插件"><a href="#使用-shade-插件" class="headerlink" title="使用 shade 插件"></a>使用 shade 插件</h2><p>在pom.xml中添加</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-shade-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">createDependencyReducedPom</span>&gt;</span>false<span class="tag">&lt;/<span class="name">createDependencyReducedPom</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">transformers</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">transformer</span> <span class="attr">implementation</span>=<span class="string">&quot;org.apache.maven.plugins.shade.resource.ManifestResourceTransformer&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 下面这个改成运行jar包时需要执行的java类 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>cn.devmgr.client.NewMain<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">transformer</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">transformers</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>shade<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>createDependencyReducedPom 是用来告诉shade不要生成dependency-reduced-pom.xml文件的，配置成true（默认）每次打包时会自动在pom.xml同级目录生成这个文件，如果配置成true，建议把此文件假如.gitignore。</p>
<p>mainClass用来指定启动类，特别注意这个启动类，不能是javaFX的启动类，要另写一个。</p>
<h2 id="创建一个仅供shade插件用的启动类"><a href="#创建一个仅供shade插件用的启动类" class="headerlink" title="创建一个仅供shade插件用的启动类"></a>创建一个仅供shade插件用的启动类</h2><p>不能把javaFX的启动类直接配置给shade插件，否则打包后的文件会运行不起来。出现类似 <code>Error: JavaFX runtime components are missing, and are required to run this application  </code>这样的错误提示。要解决它，需要做一个新的，不使用javaFX的启动类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.devmgr.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewMain</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    MainApp.main(args);  <span class="comment">//MainApp是javaFX的启动类，直接调用它即可</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这是由于javaFX启动机制和打包成一个大jar后对分jar运行的改变造成的，详细可参考</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/52653836/maven-shade-javafx-runtime-components-are-missing">https://stackoverflow.com/questions/52653836/maven-shade-javafx-runtime-components-are-missing</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/52569724/javafx-11-create-a-jar-file-with-gradle/52571719#52571719">https://stackoverflow.com/questions/52569724/javafx-11-create-a-jar-file-with-gradle/52571719#52571719</a></li>
</ol>
<h2 id="pom-xml-里的javaFX依赖"><a href="#pom-xml-里的javaFX依赖" class="headerlink" title="pom.xml 里的javaFX依赖"></a>pom.xml 里的javaFX依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.openjfx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javafx-controls<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>15.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.openjfx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javafx-fxml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>15.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.openjfx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javafx-media<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>15.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.openjfx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javafx-graphics<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>15.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">classifier</span>&gt;</span>mac<span class="tag">&lt;/<span class="name">classifier</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.openjfx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javafx-graphics<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>15.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">classifier</span>&gt;</span>win<span class="tag">&lt;/<span class="name">classifier</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里只列出来了我使用到的几个，其他（例如webview）如果项目中使用，需要再增加依赖。<br>特别注意webview和javafx-graphics一样，分平台不同包的，而且体积很大。</p>
<h2 id="IntelliJ-IDEA-里直接运行时遇到的错误"><a href="#IntelliJ-IDEA-里直接运行时遇到的错误" class="headerlink" title="IntelliJ IDEA 里直接运行时遇到的错误"></a>IntelliJ IDEA 里直接运行时遇到的错误</h2><p>在idea里直接运行javaFX启动类，如果遇到以下错误</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Graphics Device initialization failed for :  es2, sw</span><br><span class="line">Error initializing QuantumRenderer: no suitable pipeline found</span><br><span class="line">java.lang.RuntimeException: java.lang.RuntimeException: Error initializing QuantumRenderer: no suitable pipeline found</span><br><span class="line">	at javafx.graphics&#x2F;com.sun.javafx.tk.quantum.QuantumRenderer.getInstance(QuantumRenderer.java:280)</span><br><span class="line">	at javafx.graphics&#x2F;com.sun.javafx.tk.quantum.QuantumToolkit.init(QuantumToolkit.java:244)</span><br><span class="line">	at javafx.graphics&#x2F;com.sun.javafx.tk.Toolkit.getToolkit(Toolkit.java:261)</span><br><span class="line">	at javafx.graphics&#x2F;com.sun.javafx.application.PlatformImpl.startup(PlatformImpl.java:267)</span><br><span class="line">	at javafx.graphics&#x2F;com.sun.javafx.application.PlatformImpl.startup(PlatformImpl.java:158)</span><br></pre></td></tr></table></figure>

<p>而且命令行运行没问题，这很可能是idea使用了不是自己平台的javafx-graphics包导致的。<br>例如我在mac idea里，如果maven pom.xml的两个javafx-graphics win在前，mac在后就会出现这个异常，只需要把自己平台的调整到前面，reimport就好。</p>
<h2 id="IntelliJ-IDEA-里对module-java-java的错误提示及原因"><a href="#IntelliJ-IDEA-里对module-java-java的错误提示及原因" class="headerlink" title="IntelliJ IDEA 里对module-java.java的错误提示及原因"></a>IntelliJ IDEA 里对module-java.java的错误提示及原因</h2><p>idea 里会提示module-java.java中有一个错误</p>
<p>  Module ‘xxx’ reads package ‘javafx.animation’ from both ‘javafx.graphics’ and ‘javafx.graphics’</p>
<p>这个提示不影响运行，出现这个提示的原因是 javafx.graphics 在依赖中出现了2次。<br>此处出现两次是因为pom.xml的确写了2个javafx-graphics的依赖（mac和win两个）。如果不需要跨平台，pom里只写一个，也就不会出现这个提示了。</p>
<h2 id="一个完整的-pom-xml"><a href="#一个完整的-pom-xml" class="headerlink" title="一个完整的 pom.xml"></a>一个完整的 pom.xml</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.devmgr.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>client-tool<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>11<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>11<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">javafx.maven.plugin.version</span>&gt;</span>0.0.6<span class="tag">&lt;/<span class="name">javafx.maven.plugin.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.openjfx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javafx-controls<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>15.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.openjfx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javafx-fxml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>15.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.openjfx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javafx-media<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>15.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.openjfx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javafx-graphics<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>15.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">classifier</span>&gt;</span>mac<span class="tag">&lt;/<span class="name">classifier</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.openjfx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javafx-graphics<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>15.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">classifier</span>&gt;</span>win<span class="tag">&lt;/<span class="name">classifier</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.31<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-math3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.6.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-codec<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-codec<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.15<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpmime<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.5.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi-ooxml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.12.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.12.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.5.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpcore<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.xerial<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sqlite-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.36.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>default-compile<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">source</span>&gt;</span>11<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">target</span>&gt;</span>11<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>default-testCompile<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>test-compile<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">goal</span>&gt;</span>testCompile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">source</span>&gt;</span>11<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">target</span>&gt;</span>11<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">source</span>&gt;</span>11<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">target</span>&gt;</span>11<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.openjfx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javafx-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;javafx.maven.plugin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>cn.devmgr.client.MainApp<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-shade-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="comment">&lt;!--          &lt;createDependencyReducedPom&gt;false&lt;/createDependencyReducedPom&gt;--&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">transformers</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">transformer</span> <span class="attr">implementation</span>=<span class="string">&quot;org.apache.maven.plugins.shade.resource.ManifestResourceTransformer&quot;</span>&gt;</span></span><br><span class="line">              <span class="comment">&lt;!-- 下面这个改成运行jar包时需要执行的java类 --&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>cn.devmgr.client.NewMain<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">transformer</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">transformers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">goal</span>&gt;</span>shade<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="maven-命令行"><a href="#maven-命令行" class="headerlink" title="maven 命令行"></a>maven 命令行</h2><h3 id="运行javaFX项目"><a href="#运行javaFX项目" class="headerlink" title="运行javaFX项目"></a>运行javaFX项目</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn javafx:run</span><br></pre></td></tr></table></figure>

<h3 id="打包（和其他maven项目相同）"><a href="#打包（和其他maven项目相同）" class="headerlink" title="打包（和其他maven项目相同）"></a>打包（和其他maven项目相同）</h3><p>和其他maven项目完全相同，只是打包完毕target目录下的jar包很大。 fat jar</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn package</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.devmgr.cn/2021/03/31/spring-gateway-%E5%BC%82%E5%B8%B8-org-springframework-core-io-buffer-databufferlimitexception-exceeded-limit-on-max-bytes-to-buffer-262144/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="GeXiangDong">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeXiangDong">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/31/spring-gateway-%E5%BC%82%E5%B8%B8-org-springframework-core-io-buffer-databufferlimitexception-exceeded-limit-on-max-bytes-to-buffer-262144/" class="post-title-link" itemprop="url">Spring Gateway 异常 org.springframework.core.io.buffer.DataBufferLimitException: Exceeded limit on max bytes to buffer : 262144</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-03-31 15:21:37 / 修改时间：15:45:15" itemprop="dateCreated datePublished" datetime="2021-03-31T15:21:37+08:00">2021-03-31</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Spring Gateway 遇到异常 org.springframework.core.io.buffer.DataBufferLimitException:<br>  Exceeded limit on max bytes to buffer : 262144<br>  堆栈如下【似乎没啥意义】</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.core.io.buffer.DataBufferLimitException: Exceeded limit on max bytes to buffer : 262144</span><br><span class="line">	at org.springframework.core.io.buffer.LimitedDataBufferList.raiseLimitException(LimitedDataBufferList.java:101)</span><br><span class="line">	Suppressed: reactor.core.publisher.FluxOnAssembly$OnAssemblyException: </span><br><span class="line">Error has been observed at the following site(s):</span><br><span class="line">	|_ checkpoint ⇢ Body from GET http:&#x2F;&#x2F;192.168.0.141:8042&#x2F;companies&#x2F;62bd6601-7139-4182-aa11-03c7cf304326&#x2F;orders&#x2F;summary&#x2F;cashierjournal?withDetails&#x3D;true&amp;beginDate&#x3D;1580572800000&amp;endDate&#x3D;1617119999000 [DefaultClientResponse]</span><br><span class="line">	|_ checkpoint ⇢ org.springframework.cloud.gateway.filter.WeightCalculatorWebFilter [DefaultWebFilterChain]</span><br><span class="line">	|_ checkpoint ⇢ org.springframework.security.web.server.authentication.logout.LogoutWebFilter [DefaultWebFilterChain]</span><br><span class="line">	|_ checkpoint ⇢ org.springframework.security.web.server.savedrequest.ServerRequestCacheWebFilter [DefaultWebFilterChain]</span><br><span class="line">	|_ checkpoint ⇢ org.springframework.security.web.server.context.SecurityContextServerWebExchangeWebFilter [DefaultWebFilterChain]</span><br><span class="line">	|_ checkpoint ⇢ org.springframework.security.web.server.context.ReactorContextWebFilter [DefaultWebFilterChain]</span><br><span class="line">	|_ checkpoint ⇢ org.springframework.security.web.server.header.HttpHeaderWriterWebFilter [DefaultWebFilterChain]</span><br><span class="line">	|_ checkpoint ⇢ org.springframework.security.config.web.server.ServerHttpSecurity$ServerWebExchangeReactorContextWebFilter [DefaultWebFilterChain]</span><br><span class="line">	|_ checkpoint ⇢ org.springframework.security.web.server.WebFilterChainProxy [DefaultWebFilterChain]</span><br><span class="line">	|_ checkpoint ⇢ org.springframework.boot.actuate.metrics.web.reactive.server.MetricsWebFilter [DefaultWebFilterChain]</span><br><span class="line">	|_ checkpoint ⇢ HTTP GET &quot;&#x2F;web&#x2F;companies&#x2F;62bd6601-7139-4182-aa11-03c7cf304326&#x2F;journal&#x2F;cashier?withDetails&#x3D;true&amp;beginDate&#x3D;1580572800000&amp;endDate&#x3D;1617119999000&quot; [ExceptionHandlingWebHandler]</span><br><span class="line">Stack trace:</span><br><span class="line">		at org.springframework.core.io.buffer.LimitedDataBufferList.raiseLimitException(LimitedDataBufferList.java:101)</span><br><span class="line">		at org.springframework.core.io.buffer.LimitedDataBufferList.updateCount(LimitedDataBufferList.java:94)</span><br><span class="line">		at org.springframework.core.io.buffer.LimitedDataBufferList.add(LimitedDataBufferList.java:59)</span><br><span class="line">		at reactor.core.publisher.MonoCollect$CollectSubscriber.onNext(MonoCollect.java:119)</span><br><span class="line">		at reactor.core.publisher.FluxMap$MapSubscriber.onNext(FluxMap.java:114)</span><br><span class="line">		at reactor.core.publisher.FluxPeek$PeekSubscriber.onNext(FluxPeek.java:192)</span><br><span class="line">		at reactor.core.publisher.FluxPeek$PeekSubscriber.onNext(FluxPeek.java:192)</span><br><span class="line">		at reactor.core.publisher.FluxMap$MapSubscriber.onNext(FluxMap.java:114)</span><br><span class="line">		at reactor.netty.channel.FluxReceive.drainReceiver(FluxReceive.java:213)</span><br><span class="line">		at reactor.netty.channel.FluxReceive.onInboundNext(FluxReceive.java:346)</span><br><span class="line">		at reactor.netty.channel.ChannelOperations.onInboundNext(ChannelOperations.java:348)</span><br><span class="line">		at reactor.netty.http.client.HttpClientOperations.onInboundNext(HttpClientOperations.java:572)</span><br><span class="line">		at reactor.netty.channel.ChannelOperationsHandler.channelRead(ChannelOperationsHandler.java:93)</span><br><span class="line">		at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:374)</span><br><span class="line">		at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:360)</span><br><span class="line">		at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:352)</span><br><span class="line">		at io.netty.handler.codec.MessageToMessageDecoder.channelRead(MessageToMessageDecoder.java:102)</span><br></pre></td></tr></table></figure>
<p>这个异常的原因很明确，返回内容超过了默认能解析的256k的大小，怎么增加这个buffer？</p>
<p>网上搜索大多是说可以在 application.yml 配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">codec:</span></span><br><span class="line">    <span class="attr">max-in-memory-size:</span> <span class="string">5MB</span></span><br></pre></td></tr></table></figure>

<p>按照这个修改后，不起作用。网上还有说是spring版本问题…</p>
<p>这个是我自己的GatewayFilter问题，访问到了自定义的一个Filter， 这个filter创建的请求使用了默认值，没有用 application.yml中的配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">WebClient.builder()</span><br><span class="line">        .build()</span><br><span class="line">        <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>改成如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">WebClient.builder()</span><br><span class="line">        .exchangeStrategies(</span><br><span class="line">            ExchangeStrategies.builder()</span><br><span class="line">                .codecs(c -&gt; c.defaultCodecs().maxInMemorySize(<span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span>)) <span class="comment">// 10M json解析</span></span><br><span class="line">                .build())</span><br><span class="line">        .build()</span><br><span class="line">        <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>这里写死了10M，也可以优雅一点，从application.yml中读取配置值。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.devmgr.cn/2020/11/07/elasticsearch%E8%BF%9B%E5%85%A5%E5%8F%AA%E8%AF%BB%E6%A8%A1%E5%BC%8F%EF%BC%8Cjava%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BC%82%E5%B8%B8-org-elasticsearch-cluster-block-clusterblockexception-blocked-by-forbidden-12-index-read-only-allow-delete-api/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="GeXiangDong">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeXiangDong">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/07/elasticsearch%E8%BF%9B%E5%85%A5%E5%8F%AA%E8%AF%BB%E6%A8%A1%E5%BC%8F%EF%BC%8Cjava%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BC%82%E5%B8%B8-org-elasticsearch-cluster-block-clusterblockexception-blocked-by-forbidden-12-index-read-only-allow-delete-api/" class="post-title-link" itemprop="url">elasticsearch进入只读模式，java客户端异常: org.elasticsearch.cluster.block.ClusterBlockException: blocked by: [FORBIDDEN/12/index read-only / allow delete (api)]</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-11-07 16:49:42 / 修改时间：16:55:28" itemprop="dateCreated datePublished" datetime="2020-11-07T16:49:42+08:00">2020-11-07</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h1><pre><code>错误日志

org.elasticsearch.cluster.block.ClusterBlockException: blocked by: [FORBIDDEN/12/index read-only / allow delete (api)];
    at org.elasticsearch.cluster.block.ClusterBlocks.indexBlockedException(ClusterBlocks.java:183)
    at org.elasticsearch.action.support.replication.TransportReplicationAction.blockExceptions(TransportReplicationAction.java:255)
    at org.elasticsearch.action.support.replication.TransportReplicationAction.access$500(TransportReplicationAction.java:100)
    at org.elasticsearch.action.support.replication.TransportReplicationAction$ReroutePhase.doRun(TransportReplicationAction.java:780)
    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)
    at org.elasticsearch.action.support.replication.TransportReplicationAction.doExecute(TransportReplicationAction.java:172)
    at org.elasticsearch.action.support.replication.TransportReplicationAction.doExecute(TransportReplicationAction.java:100)
    at org.elasticsearch.action.support.TransportAction$RequestFilterChain.proceed(TransportAction.java:167)
    at org.elasticsearch.xpack.security.action.filter.SecurityActionFilter.apply(SecurityActionFilter.java:124)
    at org.elasticsearch.action.support.TransportAction$RequestFilterChain.proceed(TransportAction.java:165)
    at org.elasticsearch.action.support.TransportAction.execute(TransportAction.java:139)
    at org.elasticsearch.action.support.TransportAction.execute(TransportAction.java:81)
    at org.elasticsearch.action.bulk.TransportBulkAction$BulkOperation.doRun(TransportBulkAction.java:420)
    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)
    at org.elasticsearch.action.bulk.TransportBulkAction.executeBulk(TransportBulkAction.java:533)
    at org.elasticsearch.action.bulk.TransportBulkAction.executeIngestAndBulk(TransportBulkAction.java:271)
    at org.elasticsearch.action.bulk.TransportBulkAction.doExecute(TransportBulkAction.java:188)
    at org.elasticsearch.action.bulk.TransportBulkAction.doExecute(TransportBulkAction.java:90)
    at org.elasticsearch.action.support.TransportAction$RequestFilterChain.proceed(TransportAction.java:167)
    at org.elasticsearch.xpack.security.action.filter.SecurityActionFilter.apply(SecurityActionFilter.java:124)
    at org.elasticsearch.action.support.TransportAction$RequestFilterChain.proceed(TransportAction.java:165)
    at org.elasticsearch.action.support.TransportAction.execute(TransportAction.java:139)
    at org.elasticsearch.action.bulk.TransportSingleItemBulkWriteAction.doExecute(TransportSingleItemBulkWriteAction.java:69)
    at org.elasticsearch.action.bulk.TransportSingleItemBulkWriteAction.doExecute(TransportSingleItemBulkWriteAction.java:44)
    at org.elasticsearch.action.support.TransportAction$RequestFilterChain.proceed(TransportAction.java:167)
    at org.elasticsearch.xpack.security.action.filter.SecurityActionFilter.apply(SecurityActionFilter.java:124)
    at org.elasticsearch.action.support.TransportAction$RequestFilterChain.proceed(TransportAction.java:165)
    at org.elasticsearch.action.support.TransportAction.execute(TransportAction.java:139)
    at org.elasticsearch.action.support.replication.TransportReplicationAction$OperationTransportHandler.messageReceived(TransportReplicationAction.java:284)
    at org.elasticsearch.action.support.replication.TransportReplicationAction$OperationTransportHandler.messageReceived(TransportReplicationAction.java:276)
    at org.elasticsearch.xpack.security.transport.SecurityServerTransportInterceptor$ProfileSecuredRequestHandler$1.doRun(SecurityServerTransportInterceptor.java:250)
    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)
    at org.elasticsearch.xpack.security.transport.SecurityServerTransportInterceptor$ProfileSecuredRequestHandler.messageReceived(SecurityServerTransportInterceptor.java:308)
    at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:66)
    at org.elasticsearch.transport.TcpTransport$RequestHandler.doRun(TcpTransport.java:1289)
    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)
    at org.elasticsearch.common.util.concurrent.EsExecutors$1.execute(EsExecutors.java:140)
    at org.elasticsearch.transport.TcpTransport.handleRequest(TcpTransport.java:1247)
    at org.elasticsearch.transport.TcpTransport.messageReceived(TcpTransport.java:1111)
    at org.elasticsearch.transport.TcpTransport.inboundMessage(TcpTransport.java:914)
    at org.elasticsearch.transport.netty4.Netty4MessageChannelHandler.channelRead(Netty4MessageChannelHandler.java:53)
    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362)
    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348)
    at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:340)
    at io.netty.handler.codec.ByteToMessageDecoder.fireChannelRead(ByteToMessageDecoder.java:323)
    at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:297)
    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362)
    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348)
    at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:340)
    at io.netty.handler.logging.LoggingHandler.channelRead(LoggingHandler.java:241)
    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362)
    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348)
    at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:340)
    at io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1434)
    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362)
    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348)
    at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:965)
    at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:163)
    at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:656)
    at io.netty.channel.nio.NioEventLoop.processSelectedKeysPlain(NioEventLoop.java:556)
    at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:510)
    at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:470)
    at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:909)
    at java.lang.Thread.run(Thread.java:834)</code></pre>
<h1 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h1><p>日志里已经很明显了，elasticsearch 进入了只读模式，不能执行删除操作。</p>
<p>Elasticsearch进入只读模式是因为磁盘空间不足造成的，磁盘可用空间过低后（默认低于5%），elasticsearch会进入只读模式，即使增加了磁盘可用空间也不会自动恢复，需要通过如下 curl 命令恢复。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT -H <span class="string">&quot;Content-Type: application/json&quot;</span> http://localhost:9200/_all/_settings -d <span class="string">&#x27;&#123;&quot;index.blocks.read_only_allow_delete&quot;: null&#125;&#x27;</span></span><br></pre></td></tr></table></figure>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/50609417/elasticsearch-error-cluster-block-exception-forbidden-12-index-read-only-all">https://stackoverflow.com/questions/50609417/elasticsearch-error-cluster-block-exception-forbidden-12-index-read-only-all</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">GeXiangDong</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">101</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">141</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-gg"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">GeXiangDong</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
